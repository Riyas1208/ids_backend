from fastapi import APIRouter, HTTPException, Depends
from pydantic import BaseModel
from typing import Optional
from app.core.security import require_api_key
from app.services.scan_service import run_command
from app.schemas import PentestResult

router = APIRouter()

class SqlmapTarget(BaseModel):
    url: str
    timeout: Optional[int] = 60

@router.post('/sql', response_model=PentestResult)
async def run_sqlmap(payload: SqlmapTarget, ok: bool = Depends(require_api_key)):
    url = payload.url.strip()
    timeout = payload.timeout or 60
    if not url:
        raise HTTPException(status_code=400, detail='Missing url')
    if url.startswith('http://127.') or url.startswith('http://10.') or url.startswith('http://192.168.'):
        raise HTTPException(status_code=400, detail='Private network not allowed')
    cmd = ['sqlmap','-u',url,'--batch','--threads=2']
    code, out, err = await run_command(cmd, timeout=min(timeout,120))
    if code == -2:
        raise HTTPException(status_code=503, detail='sqlmap not installed')
    if code < 0:
        raise HTTPException(status_code=500, detail=f'pentest failed: {err}')
    summary = {'note':'see raw output'}
    return PentestResult(target=url, tool='sqlmap', summary=summary, raw=out)
